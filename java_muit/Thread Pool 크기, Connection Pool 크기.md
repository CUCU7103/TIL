# Thread Pool 크기, Connection Pool 크기

- 소프트웨어 개발에서 성능 최적화는 중요한 과제 중 하나입니다. 
- 특히, 멀티스레드 환경에서 스레드 풀과 데이터베이스(DB) 커넥션 풀은 애플리케이션의 성능과 직결되는 핵심 요소입니다.

### Connection Pool이 커지면 성능은 무조건 좋아질까요?

- 무조건 커진다고 좋아지지 않습니다. 

  - WAS에서 Connection을 사용하는 주체는 Thread입니다. 그렇다면 Thread Pool의 크기보다 Connection Pool의 크기가 크다면

  - Thread Pool에서 트랜잭션을 처리하는 Thread가 사용하는 Connection 외에 남는 Connection은 실질적으로 메모리 공간만 차지하게 됩니다. 

###  Thread pool 크고 Connection pool이 작은 경우

- 다수의 스레드가 동시에 DB 커넥션을 얻으려 합니다. 
- 준비된 커넥션 수보다 스레드 수가 많으면, 이미 할당된 커넥션들이 반환될 때까지 남은 스레드들은 블로킹 상태에 놓이게 됩니다.

###  Connection pool의 증가에 따라서 Thread pool을 증가시켜주면 되지 않을까?

- 스레드 수가 많아지면 CPU 사용량 증가, 스레드 스택 메모리 사용량 증가 등의 문제가 발생합니다. 

  - 스레드 풀의 스레드 수를 늘리면 운영체제는 이 스레드들을 CPU 코어에 할당하기 위해 더 많은 스케줄링 작업을 수행해야 합니다. 

  - 이는 다음과 같은 오버헤드를 유발합니다:

    - **CPU 사용량 증가**:

      - 스레드 수가 CPU 코어 수를 크게 초과하면, 많은 스레드가 실제 연산 대신 컨텍스트 스위칭에 소요됩니다.

      - **컨텍스트 스위칭 오버헤드**
        -  CPU가 한 스레드에서 다른 스레드로 전환할 때마다 약간의 비용이 듭니다.
        -  스레드 수가 지나치게 많으면 이 전환 비용이 누적되어 전체 성능을 떨어뜨립니다.

      - **메모리 사용량 증가(스레드 스택)**: 
        - 각 스레드는 스택 메모리를 필요로 하므로, 스레드 수가 많아질수록 메모리 사용량이 증가합니다.

  - 즉 스레드를 많이 늘린다고 해서 항상 처리량이 증가하는 것은 아닙니다. 

  - 일정 임계점을 넘어서면 컨텍스트 스위칭과 메모리 오버헤드 때문에 오히려 성능이 악화될 수 있습니다

    

- 커넥션을 늘리면 데이터베이스 측 메모리 점유량, 동시 접근에 따른 경합(Contension)도 증가합니다. 

  - **락(LOCK) 경합 증가**
    - 많은 커넥션이 동시에 쿼리를 실행하면 동일한 데이터나 인덱스에 대한 접근 경합이 심해집니다. 이는 대기 시간 증가, 처리량 감소로 이어질 수 있습니다.
  - **과부하 시 성능 저하**:
    - 커넥션이 너무 많아지면, DB는 실제 쿼리 처리보다 동시성 제어(락 관리, 트랜잭션 처리)에서 더 많은 시간을 소모하게 되고, 이는 성능 저하 또는 시스템 불안정성으로 이어질 수 있습니다.
  - 결국 시스템 한계를 초과하면 성능 저하나 불안정성이 야기될 수 있습니다.



### 최적의 처리량을 위한 가이드라인

HikariCP wiki에서는 이 공식대로 Maximum pool size를 설정하면 Dead lock을 피할 수 있다고 합니다.![magic-formula](https://techblog.woowahan.com/wp-content/uploads/img/2020-02-06/magic-formula.png)

- *Tn* : 전체 Thread 갯수
- *Cm* : 하나의 Task에서 동시에 필요한 Connection 수

