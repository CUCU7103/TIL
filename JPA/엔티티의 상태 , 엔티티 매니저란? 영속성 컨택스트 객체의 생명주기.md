# 엔티티의 상태, 엔티티 매니저란?, 영속성 컨택스트 객체의 생명주기

### 엔티티(Entity)는 영속성 컨택스트를 기준으로 4가지 상태를 가집니다.

#### 1. 비영속 

- 객체가 생성되었지만 영속성 컨택스트에 관리되지 않는 상태
- DB나 JPA와 아무 관련 없는 자바 객체

#### 2. 영속

- 엔티티가 영속성 컨택스트에 저장되어 관리되어지는 상태입니다.
- 1차 캐시, 쓰기 지연, 변경 감지의 대상입니다

#### 3. 준영속

- 이전에는 영속 상태였으나 영속성 컨택스트에서 분리된 상태
- 영속성 컨텍스트가  닫히면 그 안에 있던 영속 객체는 준영속 상태가 된다.

#### 4. 삭제

- 영속성 컨택스트에서 관리되고 있으나 삭제하기로 표시된 상태
- 다음 flush 작업 때 delete 쿼리가 지연 저장소에 들어갑니다.



### 엔티티 매니저

- 영속성 컨택스트에 대한 작업을 수행함으로써 자바 프로그램과 데이터베이스 사이를 연결하는 역할을 합니다.
  - 즉 엔티티의 상태를 바꿈으로써 자바 프로그램과 데이터베이스 사이를 연결한다.
  - 엔티티 매니저는 메서드를 통해 영속성 컨택스트와 소통하면서 엔티티의 상태를 바꾼다.



- 엔티티의 생명주기,  매니저가 사용하는 함수들
<br>

![image](https://github.com/user-attachments/assets/e5fed803-1087-49b6-b1eb-8519f6afb286)



<br>

## 영속성 컨택스트의 생명주기



### 1. **컨테이너 관리 영속성 컨택스트**

- 컨테이너 관리 방식에서는 애플리케이션 서버나 프레임워크(예: 스프링)가 `EntityManager`와 영속성 컨텍스트의 생명주기를 자동으로 관리합니다. 
- 개발자는 주로 설정과 어노테이션을 통해 이를 정의하며, 실제 관리 과정은 컨테이너에 위임됩니다.



#### **생성 및 관리**

- **의존성 주입**: `@PersistenceContext` 어노테이션을 사용하여 `EntityManager`를 주입받습니다.

``` java
@PersistenceContext
private EntityManager em;

```

**생명주기**:

- **트랜잭션 범위(Persistence Context Type.TRANSACTION)**

  - **트랜잭션 시작 시**: 영속성 컨텍스트가 생성됩니다.
  - **트랜잭션 종료 시**: 영속성 컨텍스트가 소멸되며, 변경 사항이 데이터베이스에 반영됩니다.
  - **주로 사용 시기**: 단일 트랜잭션 내에서 작업을 수행할 때 적합합니다.

  

- **확장 범위(Persistence Context Type.EXTENDED)**

  - **상태 유지**: 여러 트랜잭션에 걸쳐 영속성 컨텍스트가 유지됩니다.

  - **사용 예**: 상태 저장(Stateful) 빈에서 장기적인 대화형 작업을 수행할 때 사용됩니다

    

#### **소멸**

- **트랜잭션 종료 시**: 트랜잭션이 커밋되거나 롤백되면 영속성 컨텍스트도 자동으로 소멸됩니다.
- **컨테이너에 의해 관리**: 개발자가 별도로 `EntityManager`를 닫을 필요가 없습니다.



### **2. 애플리케이션 관리(Application-Managed) 영속성 컨텍스트**

- 애플리케이션 관리 방식에서는 개발자가 직접 `EntityManager`와 영속성 컨텍스트의 생명주기를 관리합니다. 
- 이는 보다 세밀한 제어가 필요할 때 유용하지만, 개발자가 직접 생성 및 소멸을 책임져야 합니다.



#### **생성 및 관리**

- **EntityManagerFactory를 통한 생성**

``` java
EntityManagerFactory emf = Persistence.createEntityManagerFactory("my-pu");
EntityManager em = emf.createEntityManager();

```



**생명주기**:

- **수동 관리**: 
  - 개발자가 `EntityManager`의 생성과 소멸을 명시적으로 제어합니다.
- **트랜잭션과의 연계**: 
  - 트랜잭션의 시작과 종료 시점을 개발자가 직접 관리하며, 그에 따라 영속성 컨텍스트도 생성되고 소멸됩니다.



#### **소멸**

- **명시적 종료**:

  ```
  em.close();
  ```

  

- **리소스 관리**: 개발자가 `EntityManager`를 닫지 않으면 리소스 누수가 발생할 수 있으므로, 반드시 적절한 시점에 `close()` 메서드를 호출해야 합니다.



![image-20241106003128683](C:\Users\syste\AppData\Roaming\Typora\typora-user-images\image-20241106003128683.png)



> [!NOTE]
>
> ### **영속성 컨텍스트 생명주기의 주요 단계**
>
> 1. **생성**:
>    - **컨테이너 관리**: 트랜잭션 시작 시 자동 생성.
>    - **애플리케이션 관리**: `EntityManagerFactory`를 통해 명시적으로 생성.
> 2. **유지**:
>    - **컨테이너 관리**: 트랜잭션 범위 또는 확장 범위 내에서 유지.
>    - **애플리케이션 관리**: 개발자가 관리하는 범위 내에서 유지.
> 3. **소멸**:
>    - **컨테이너 관리**: 트랜잭션 종료 시 자동 소멸.
>    - **애플리케이션 관리**: 개발자가 `EntityManager.close()`를 호출하여 소멸.










